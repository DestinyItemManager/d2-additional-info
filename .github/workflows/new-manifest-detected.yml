# This workflow runs when a new manifest is detected by cron
name: Pull Request Merge Flow
on:
  repository_dispatch:
    types: [new-manifest-detected]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout - D2AI
        uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.SSH_KEY }}
          path: 'd2ai'

      - name: Checkout - DIM
        uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.SSH_KEY }}
          repository: DestinyItemManager/DIM
          path: 'DIM'

      - name: Install Hub
        uses: geertvdc/setup-hub@master

      - name: Install Node
        uses: actions/setup-node@v1.4.2
        with:
          node-version: '14.x'

      - name: Install Yarn (D2AI)
        uses: bahmutov/npm-install@v1
        with:
          working-directory: d2ai

      - name: Update D2AI with new manifest information
        run: |
          cd d2ai
          yarn build
          yarn manifest:get
          yarn generate-data
        env:
          API_KEY: ${{ secrets.API_KEY }},

      - name: Check for new files (D2AI)
        id: D2AI-porcelain
        run: |
          cd d2ai
          echo ::set-output name=porcelain::"$(git status --porcelain)"

      - name: Create Pull Request (D2AI)
        if: steps.D2AI-porcelain.outputs.porcelain
        env:
          GITHUB_USER: d2ai
          GITHUB_TOKEN: ${{ secrets.PAT }}
          BRANCH_NAME: '${{ github.event.client_payload.config.env.MANIFEST_VERSION }}'
          COMMIT_MSG: 'update all - manifest v${{ github.event.client_payload.config.env.MANIFEST_VERSION }}'
        run: |
          cd d2ai
          git config --global user.email "destinyitemmanager@gmail.com"
          git config --global user.name "DIM Config Bot"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "$COMMIT_MSG"
          hub pull-request -p -r sundevour,delphiactual -m "d2ai automated build update" -m "$COMMIT_MSG"

      - name: Update DIM with new info from D2AI
        run: |
          cd DIM
          find src/data/d2/* -delete
          cp -f ../d2ai/output/* ./src/data/d2/

      - name: Check for new files (DIM)
        id: DIM-porcelain
        run: |
          cd DIM
          echo ::set-output name=porcelain::"$(git status --porcelain)"

      - name: Create Pull Request (DIM)
        if: steps.DIM-porcelain.outputs.porcelain
        env:
          GITHUB_USER: d2ai
          GITHUB_TOKEN: ${{ secrets.PAT }}
          BRANCH_NAME: '${{ github.event.client_payload.config.env.MANIFEST_VERSION }}'
          COMMIT_MSG: 'update configs - manifest v${{ github.event.client_payload.config.env.MANIFEST_VERSION }}'
        run: |
          cd DIM
          git config --global user.email "destinyitemmanager@gmail.com"
          git config --global user.name "DIM Config Bot"
          if [ "$(git status --porcelain)" ]
            then
              git checkout -b "$BRANCH_NAME"
              git add -A
              git commit -m "$COMMIT_MSG"
              hub pull-request -p -r sundevour,delphiactual -m "d2ai automated config update" -m "$COMMIT_MSG"
          fi
