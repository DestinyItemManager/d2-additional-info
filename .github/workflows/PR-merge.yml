# This workflow runs when a PR is merged or a new manifest is detected by cron
name: Pull Request Merge Flow
on:
  repository_dispatch:
    types: [new-manifest-detected]
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout - D2AI
        uses: actions/checkout@v2
        with:
          path: 'd2ai'

      - name: Checkout - DIM
        uses: actions/checkout@v2
        with:
          repository: DestinyItemManager/DIM
          path: DIM

      - uses: actions/setup-node@v1.4.2
        with:
          node-version: '14.x'

      - uses: bahmutov/npm-install@v1
        with:
          working-directory: d2ai
        if: github.event == 'repository_dispatch'

      - name: Update D2AI with new manifest information
        if: github.event == 'repository_dispatch'
        run: |
          cd d2ai
          yarn manifest:get
          yarn generate-data

      - uses: repo-sync/pull-request@v2.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: d2ai-config-update-${{ github.event.client_payload.config.env.MANIFEST_VERSION }}
          pr_title: update configs - d2ai rules changed - ${{ github.event.client_payload.config.env.MANIFEST_VERSION }}
          pr_reviewer: 'delphiactual,sundevour'
          pr_label: 'd2ai,auto-pr'
        if: github.event == 'repository_dispatch'

      - name: Update DIM with new info from D2AI
        run: |
          cd DIM
          find src/data/d2/* -delete
          cp -f ../d2ai/output/* ./src/data/d2/

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: d2ai-config-update-${{ github.sha }}
          pr_title: update configs - d2ai rules changed - ${{ github.sha }}
          pr_reviewer: 'delphiactual,sundevour'
          pr_label: 'd2ai,auto-pr'
